# CVR/FDR Analysis Workflow Overview

## Viewing this document

This Markdown file includes an embedded Mermaid sequence diagram. You can open it in any Markdown viewerâ€”GitHub, VS Code, JetBrains IDEs, and most browsers with Markdown extensions all render the diagram automatically. If you prefer a standalone asset for sharing, use the Mermaid CLI to export the diagram:

```bash
npx -y @mermaid-js/mermaid-cli -i docs/cvr-fdr-workflow-diagram.md -o docs/cvr-fdr-workflow.png
```

The command above generates a `docs/cvr-fdr-workflow.png` snapshot that you can distribute to your team or embed in presentations. Adjust the output filename or format (for example, `-o docs/cvr-fdr-workflow.pdf`) as needed.

The diagram below illustrates how the React front end, Express backend, PostgreSQL database, and the planned MinIO object storage layer collaborate to manage CVR/FDR cases.

```mermaid
%%{init: {"themeVariables": {"fontSize": "16px", "fontFamily": "'Inter', 'Arial', sans-serif"}} }%%
sequenceDiagram
    autonumber
    participant FE as React Front End
    participant API as Express API Server
    participant Store as Object Storage (Future MinIO S3)
    participant AI as AI Insights Service (Future)
    participant DB as PostgreSQL

    FE->>API: POST /api/auth/login (email, password)
    API->>DB: SELECT user by email
    DB-->>API: Return user + password hash
    API-->>FE: Issue JWT access token

    FE->>API: GET /api/cases (Bearer token)
    API->>DB: SELECT cases for tenant/filters
    DB-->>API: Case records
    API-->>FE: Case list JSON

    FE->>API: POST /api/cases (metadata, analyses, timeline)
    API->>DB: INSERT case row
    DB-->>API: New case ID
    API-->>FE: Created case payload

    opt Future CVR/FDR uploads
        FE->>API: Request MinIO upload target
        API-->>FE: Return presigned URL + metadata fields
        FE->>Store: Upload CVR/FDR files to MinIO
        API->>DB: Store object keys in attachments JSONB
    end

    opt Future AI-assisted insights
        API->>AI: Submit case metadata & storage keys
        AI-->>API: Return analysis summary & anomalies
        API->>DB: Persist AI insights within analyses JSONB
        API-->>FE: Surface AI findings in case detail view
    end

    FE->>API: PATCH /api/cases/:id (status, notes, analyses)
    API->>DB: UPDATE case row
    DB-->>API: Updated case record
    API-->>FE: Persisted case response
```

## Key Interaction Notes

- **Authentication & authorization** rely on JWT tokens issued by the Express API after validating user credentials against PostgreSQL.
- **Case management** flows (list, create, update) travel from the React client through the REST endpoints to PostgreSQL using the existing services and data mappers.
- **Structured artifacts** such as analyses, timelines, and attachments are persisted as JSONB within the `cases` table until binary asset storage is introduced.
- **Object storage (planned)** will use MinIO to host large CVR/FDR files, with presigned URLs generated by the API and the resulting keys stored alongside case metadata.
- **AI-assisted insights (planned)** will process stored recordings via a dedicated AI service, feeding summary findings back through the API so they can be reviewed within each case.

This flow keeps the system modular, scalable, and aligned with the existing React SPA architecture.